# 第二阶段实验日志

## 第1天

## 第2天

这两天进入了K210的小组，了解了一些同学。
下午听了国科大同学一生一芯处理器的报告。

简介，开发过程，经验，展望

芯片基本情况。处理器：“果壳”，9级双发射，RV64IMAC，M、S、U，L1、L2，流片内有高速缓存，chisel语言，有外设，Linux可用
110纳米工艺，200mW@350MHz，100脚封装
有板卡，运行Linux，图形界面，运行虚拟机，网络，动态语言脚本。PCIE的SSD上运行，挂载在NVME的设备上
不用SDRAM时，可以到200MHz。CoreMark：1.49/MHz

2019/9月到12月开发结束。前端开发过程包括高速缓存、Sv39到时序优化、适配系统等各个过程。
板卡设计失误，险些报废芯片，后修复。如果未来需要调试软件，很难想到问题会出现在硬件上。
采访：流片困难吗？同学们都设计前端，较少接触硬件。前端上逻辑、时序设计要求都非常高。流片的时间节点压力非常大。
流片的压力非常大，如果有问题，后面的软件就无法修改。冻结时间提前一个月。
后端和前端的优化暂时不多。四个月的时间是比较困难的，需要很多团队的支持，包括开源工具，有支持基础。
从零开始做会是比较难的，后续的推广可能不是每年都能做这么复杂的事情。

项目的复杂性是什么时候认识到的，如何应对？程序出现问题之后，需要关注自己项目的正确性和验证环节的正确性，
如果一开始只会一些简单的应用，就很容易出现一些漏洞。
复杂的项目需要注意版本管理的方法。
这个项目的复杂性在后期各个部分的验证中。前期先把核看成黑盒，但是后期需要做软件测试，需要了解核内是怎么构成的。
外设有很多种，需要了解所有的外设代码。转变心态。
用类似于面向对象的思想去处理核。慢慢进入黑盒的各个部分，再定位问题在哪个部件，最后找到问题。

Chisel强调面向对象，和Verilog的区别，类似于Java和汇编语言。
使用了一套处理器在线差分测试仿真验证的框架。因为qemu只能搭建几个周期的寄存器值等等，比对状态，使用了nemu。
验证CPU模块：核内可以差分测试，核外不行。核外可以使用回环测试，比如验证以太网模块等等，可以采用短接TX、RX的方法。
第二级缓存预取部分，发现漏洞可以解决，难的在于在没有漏洞的前提下如何提升性能。
需要使用回归测试。写脚本，遍历所有的设置。

印象最深刻的漏洞。跑了33亿条指令才出现问题。是跨页指令的问题，需要有仿真机制才能找到，定位这个问题相当困难。
GPIO的四个引脚。已经到ASIC过程，发现IO板的模型，“OEN”引脚的“N”其实表示低位有效，没有接对。变量名没起好，方言不同。
快表地址对的，取出来的地址错了。发现是软件没有刷新快表。
分支预测器对高速缓存有一些隐含条件，修复后性能就回去了。

适配操作系统的过程中有哪些困难？分为流片之前的开发和流片后的测试。
Sv39分页，内核和用户暂时没有超过1GB，共享了一个巨页，用户空间的内存能被内核发现。这其实是软件问题。
FreeRTOS没有坑，它非常小。还有一个RT-Thread，添加了RV64的支持，比如把指令lw改成ld等等。
还有一个ALIGN(4)改成ALIGN(8)的问题，属于RV32移植到RV64里面。
xv6没刷新快表，出现一些机制支持不正确。用官方的xv6跑芯片，一定要刷新快表。涉及到Linux系统的进程分支操作。
软件中断没有实现，导致远程刷新页表没有实现，远程的快表没有刷新。硬件上暂时是单核，不实现机器软中断。
如果一生一芯要支持多核，就必须实现软中断。
闪存只能读4字节，没法读8字节，而且没法写，只能擦除。放在2字节对齐的4字节指令会出问题，闪存里面只能跑4字节指令。
misa的问题。导致收到的是M模式的缺页，而不是S模式。
虚拟动态共享对象vDSO，允许在不陷入内核的前提下做一些简单的调用。

## 第3天

前一天晚上和老师交流。有一个做操作系统协程的灵感，就是首先

早上和向老师、小组同学交流。我继续开发rustsbi软件，先把rCore教程的系统跑在现在的SBI实现里面。
后续的SBI实现还包含很多模块，包括硬件线程监测和管理模块，还需要很多事情要做。包括跨核刷新页表也是这样的。

下午到清华伯克利深圳学院听了RIOS组织的报告。
RISC-V和arm系区别的是，标准是免费的，然后有授权的设计反而是最多的，封闭的设计可能差不多，RISC-V存在大量的免费设计。这里稍微提了一下法律的问题，如何防范专利上糟糕的问题，然后开源的核在法律上是一个新的领域。

RIOS组织正在达成一个五年目标，提出了一个称作PicoRio的开放架构。希望能减少开发者的开销，有一款文档详细的单板计算机，功率要和树莓派板子对标。
PicoRio的开发分为三个阶段，第一阶段希望实现异构多核的处理器，要实现还在草稿中的RISC-V的动态语言J扩展，跑Linux，跑Chrome OS的内核。希望在今年秋天发布第一个版本。
第二个阶段希望支持图形处理器，希望支持虚拟机监视器，希望有一个WebAssembly的运行时。第三个阶段希望有更多的工业软件和更好的性能。
